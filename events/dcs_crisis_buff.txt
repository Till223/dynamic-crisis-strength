namespace = dcs

country_event = {
    id = dcs.1
    hide_window = yes
    fire_only_once = yes
    mean_time_to_happen = { days = 1 }
    trigger = { not = { has_global_flag = dcs_mod_initialized }}
    immediate = {
        every_country = {
            country_event = { id = dcs.100}
        }
        every_country = {
            country_event = { id = dcs.101}
        }
        set_global_flag = dcs_mod_initialized
    }
}

#recalculate crisis modifier, initialize dcs_variable_holder if necessary and notify player empires
country_event = {
    id = dcs.100
    hide_window = yes
	is_triggered_only = yes
    trigger = {
        OR = {
            is_country_type = ai_empire           			# Contingency
            is_country_type = swarm           				# Prethoryn Scourge
            is_country_type = extradimensional              # Unbidden
            is_country_type = synth_queen_storm             # Cetana
            #has_country_flag = end_game_crisis
        }
    }

    immediate = {
        if = {
            limit = { 
                NOR = {
                    is_variable_set = dcs_detected_vanilla_crisis
                    is_variable_set = dcs_crisis_multiplier
                }
            }
            log = "crisis event triggered for \\[This.GetName]"
            #calculate vanilla crisis strength through modifier extraction
            if = {
                limit = { not = { is_variable_set = dcs_detected_vanilla_crisis } }
                dcs_detect_vanilla_crisis_strength = yes
                log = "crisis event triggered for \\[This.GetName]"
            }
            if = {
                limit = { not = { is_variable_set = dcs_crisis_multiplier } }
                #calculate galaxy strength and proportional dynamic crisis strength
                dcs_calculate_crisis_strength = yes 
            } 
            #notify player empires
            every_country = {
                limit = { is_ai = no }
                country_event = {
                    id = dcs.300
                    days = 1
                }
            }
            save_global_event_target_as = last_crisis_empire
        }
    }
}

#apply crisis modifier
country_event = {
    id = dcs.101
    hide_window = yes
	is_triggered_only = yes
    trigger = {
        OR = {
            is_country_type = ai_empire           			# Contingency
            is_country_type = cybrex_empire       		    # Anti Contingency
            is_country_type = swarm           				# Prethoryn Scourge
            is_country_type = feral_prethoryn_infighting    # Prethoryn Scourge
			is_country_type = feral_prethoryn               # Prethoryn Scourge
            is_country_type = sentinels                     # Anti Prethoryn Scourge
            is_country_type = extradimensional              # Unbidden
            is_country_type = extradimensional_2            # Unbidden: Abberant
            is_country_type = extradimensional_3            # Unbidden: Vehement
            is_country_type = synth_queen_storm             # Cetana
            is_country_type = awakened_synth_queen          # Cetana awakend
            is_country_type = synth_queen                   # Cetana
            #has_country_flag = end_game_crisis              # Other modded crises
        }
    }

    immediate = {
        dcs_ensure_global_initialization = yes
        if = {
            limit = { not =  { is_variable_set = dcs_crisis_multiplier } }
            if = {
                limit = { 
                        is_country_type = cybrex_empire
                } 
                random_country = {
                    limit = { is_country_type = ai_empire }
                    prev = { dcs_copy_variables_from = { FROM = prev } }
                }
            } else_if = {
                limit = { 
                        OR = {
                            is_country_type = extradimensional_2
                            is_country_type = extradimensional_3
                        }
                } 
                random_country = {
                    limit = { is_country_type = extradimensional }
                    prev = { dcs_copy_variables_from = { FROM = prev } }
                }
            } else_if = {
                limit = { 
                        OR = {
                            is_country_type = feral_prethoryn_infighting
                            is_country_type = feral_prethoryn
                            is_country_type = sentinels
                        }
                }
                random_country = {
                    limit = { is_country_type = swarm }
                    prev = { dcs_copy_variables_from = { FROM = prev } }
                }
            }
        }
        dcs_apply_crisis_strength = yes
    }
}

country_event = {
    id = dcs.300
    title = dcs_report.title
	is_triggered_only = yes
    trigger = {
        is_ai = no
    }
	desc = dcs_report.desc
    picture = GFX_evt_fleet_evil

    option = {
        name = dcs_report.ok
    }
}

country_event = {
    id = dcs.400
    title = dcs_menu.title
	is_triggered_only = yes
    trigger = {
        is_ai = no
    }
    picture = GFX_evt_fleet_evil
	desc =  {
        text = dcs_menu.desc
        trigger = { 
            event_target:global_event_country = { 
                NOT = { has_country_flag = dcs_custom_crisis_multiplier_flag  }
                #NOT, because this flags meaning is reversed
                NOT = { has_country_flag = dcs_not_negate_crisis_strength } 
            } 
        }
    }
    desc =  {
        text = dcs_menu.desc.no_vanilla_negation
        trigger = { 
            event_target:global_event_country = { 
                NOT = { has_country_flag = dcs_custom_crisis_multiplier_flag } 
                has_country_flag = dcs_not_negate_crisis_strength 
            } 
        }
    }
    desc =  {
        text = dcs_menu.desc_custom_modifier
        trigger = { 
            event_target:global_event_country = { 
                has_country_flag = dcs_custom_crisis_multiplier_flag 
                #NOT, because this flags meaning is reversed
                NOT = { has_country_flag = dcs_not_negate_crisis_strength }
            } 
        }
    }
    desc =  {
        text = dcs_menu.desc_custom_modifier.no_vanilla_negation
        trigger = { 
            event_target:global_event_country = { 
                has_country_flag = dcs_custom_crisis_multiplier_flag 
                has_country_flag = dcs_not_negate_crisis_strength
            } 
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_not_negate_crisis_strength } } }
        name = dcs_menu.dcs_not_negate_crisis_strength_disable
        hidden_effect = {
            event_target:global_event_country = { 
                set_country_flag = dcs_not_negate_crisis_strength 
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { has_country_flag = dcs_not_negate_crisis_strength } }
        name = dcs_menu.dcs_not_negate_crisis_strength_enable
        hidden_effect = {
            event_target:global_event_country = { 
                remove_country_flag = dcs_not_negate_crisis_strength 
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.enable_custom_modifier
        hidden_effect = {
            event_target:global_event_country = { set_country_flag = dcs_custom_crisis_multiplier_flag }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
        name = dcs_menu.disable_custom_modifier
        hidden_effect = {
            event_target:global_event_country = { remove_country_flag = dcs_custom_crisis_multiplier_flag }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.increase_calculation_multiplier_5
        custom_tooltip = dcs_menu.increase_calculation_multiplier.tooltip
        hidden_effect = {
            event_target:global_event_country = { 
                change_variable = { which = dcs_calculation_multiplier value = 0.5 }
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.increase_calculation_multiplier
        custom_tooltip = dcs_menu.increase_calculation_multiplier.tooltip
        hidden_effect = {
            event_target:global_event_country = { 
                change_variable = { which = dcs_calculation_multiplier value = 0.1 }
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.decrease_calculation_multiplier
        custom_tooltip = dcs_menu.decrease_calculation_multiplier.tooltip
        hidden_effect = {
            event_target:global_event_country = { 
                subtract_variable = { which = dcs_calculation_multiplier value = 0.1 }
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.decrease_calculation_multiplier_5
        custom_tooltip = dcs_menu.decrease_calculation_multiplier.tooltip
        hidden_effect = {
            event_target:global_event_country = { 
                subtract_variable = { which = dcs_calculation_multiplier value = 0.5 }
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.increase_static_offset_1
        hidden_effect = {
            event_target:global_event_country = { 
                change_variable = { which = dcs_static_offset value = 1 }
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { not = { has_country_flag = dcs_custom_crisis_multiplier_flag } } }
        name = dcs_menu.decrease_static_offset_1
        hidden_effect = {
            event_target:global_event_country = { 
                subtract_variable = { which = dcs_static_offset value = 1 }
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
        name = dcs_menu.increase_custom_modifier_5
        hidden_effect = {
            event_target:global_event_country = { 
                change_variable = { which = dcs_custom_crisis_multiplier value = 5 } 
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

option = {
    trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
    name = dcs_menu.increase_custom_modifier_0.1
    hidden_effect = {
        event_target:global_event_country = { 
            change_variable = { which = dcs_custom_crisis_multiplier value = 0.1 } 
        }
        every_country = {
            country_event = {
                id = dcs.101
            }
        }
        country_event = { id = dcs.400 }
    }
}

    option = {
    trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
    name = dcs_menu.increase_custom_modifier_0.1
    hidden_effect = {
        event_target:global_event_country = { 
            change_variable = { which = dcs_custom_crisis_multiplier value = 0.1 } 
        }
        every_country = {
            country_event = {
                id = dcs.101
            }
        }
        country_event = { id = dcs.400 }
    }
}

    option = {
        trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
        name = dcs_menu.decrease_custom_modifier_1
        hidden_effect = {
            event_target:global_event_country = { 
                subtract_variable = { which = dcs_custom_crisis_multiplier value = 1 } 
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
        name = dcs_menu.decrease_custom_modifier_1
        hidden_effect = {
            event_target:global_event_country = { 
                subtract_variable = { which = dcs_custom_crisis_multiplier value = 1 } 
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        trigger = { event_target:global_event_country = { has_country_flag = dcs_custom_crisis_multiplier_flag } }
        name = dcs_menu.decrease_custom_modifier_5
        hidden_effect = {
            event_target:global_event_country = { 
                subtract_variable = { which = dcs_custom_crisis_multiplier value = 5 } 
            }
            every_country = {
                country_event = {
                    id = dcs.101
                }
            }
            country_event = { id = dcs.400 }
        }
    }

    option = {
        name = dcs_menu.close
        default_hide_option = yes
    }
}