namespace = dcs

country_event = {
    id = dcs.1
    hide_window = yes
    fire_only_once = yes
    mean_time_to_happen = { days = 1 }
    trigger = { not = { has_global_flag = dcs_mod_initialized }}
    immediate = {
        every_country = {
            country_event = { id = dcs.100}
        }
        every_country = {
            country_event = { id = dcs.101}
        }
        set_global_flag = dcs_mod_initialized
    }
}

#recalculate crisis modifier, initialize dcs_variable_holder if necessary and notify player empires
country_event = {
    id = dcs.100
    hide_window = yes
	is_triggered_only = yes
    trigger = {
        OR = {
            is_country_type = ai_empire           			# Contingency
            is_country_type = swarm           				# Prethoryn Scourge
            is_country_type = extradimensional              # Unbidden
            is_country_type = synth_queen_storm             # Cetana
            #has_country_flag = end_game_crisis
            AND = {
                is_midgame_crisis = yes
                is_midgame_crisis_active = yes
            }
        }
    }

    immediate = {
        if = {
            limit = { 
                NOR = {
                    is_variable_set = dcs_detected_vanilla_crisis
                    is_variable_set = dcs_crisis_multiplier
                }
            }
            log = "crisis event triggered for \\[This.GetName]"
            #calculate vanilla crisis strength through modifier extraction
            if = {
                limit = { not = { is_variable_set = dcs_detected_vanilla_crisis } }
                dcs_detect_vanilla_crisis_strength = yes
                log = "crisis event triggered for \\[This.GetName]"
            }
            if = {
                limit = { not = { is_variable_set = dcs_crisis_multiplier } }
                dcs_calculate_crisis_strength = yes
            } 
            #notify player empires
            every_country = {
                limit = { is_ai = no }
                country_event = {
                    id = dcs.300
                    days = 1
                }
            }
            save_global_event_target_as = last_crisis_empire
        }
    }
}

#apply crisis modifier
country_event = {
    id = dcs.101
    hide_window = yes
	is_triggered_only = yes
    trigger = {
        OR = {
            is_country_type = ai_empire           			# Contingency
            is_country_type = cybrex_empire       		    # Anti Contingency
            is_country_type = swarm           				# Prethoryn Scourge
            is_country_type = feral_prethoryn_infighting    # Prethoryn Scourge
			is_country_type = feral_prethoryn               # Prethoryn Scourge
            is_country_type = sentinels                     # Anti Prethoryn Scourge
            is_country_type = extradimensional              # Unbidden
            is_country_type = extradimensional_2            # Unbidden: Abberant
            is_country_type = extradimensional_3            # Unbidden: Vehement
            is_country_type = synth_queen_storm             # Cetana
            is_country_type = awakened_synth_queen          # Cetana awakend
            is_country_type = synth_queen                   # Cetana
            #has_country_flag = end_game_crisis              # Other modded crises
            AND = {
                is_midgame_crisis = yes
                is_midgame_crisis_active = yes
            }
        }
    }

    immediate = {
        dcs_ensure_global_initialization = yes
        if = {
            limit = { not =  { is_variable_set = dcs_crisis_multiplier } }
            if = {
                limit = { 
                        is_country_type = cybrex_empire
                } 
                random_country = {
                    limit = { is_country_type = ai_empire }
                    prev = { dcs_copy_variables_from = { FROM = prev } }
                }
            } else_if = {
                limit = { 
                        OR = {
                            is_country_type = extradimensional_2
                            is_country_type = extradimensional_3
                        }
                } 
                random_country = {
                    limit = { is_country_type = extradimensional }
                    prev = { dcs_copy_variables_from = { FROM = prev } }
                }
            } else_if = {
                limit = { 
                        OR = {
                            is_country_type = feral_prethoryn_infighting
                            is_country_type = feral_prethoryn
                            is_country_type = sentinels
                        }
                }
                random_country = {
                    limit = { is_country_type = swarm }
                    prev = { dcs_copy_variables_from = { FROM = prev } }
                }
            }
        }
        dcs_apply_crisis_strength = yes
    }
}

country_event = {
    id = dcs.300
    title = dcs_report.title
	is_triggered_only = yes
    trigger = {
        is_ai = no
    }
	desc = dcs_report.desc
    picture = GFX_evt_fleet_evil

    option = {
        name = dcs_report.ok
    }
}

#voidworms
country_event = {
    id = dcs.501
    hide_window = yes
    mean_time_to_happen = { days = 1 }
    fire_only_once = yes
    trigger = {
        is_country_type = voidworms_crisis
        has_dcs_affect_mid_game_crisis = yes
        is_voidworms_crisis_active = yes
        NOT = { has_global_flag = dcs_voidworms_buffed }
    }

    immediate = {
        set_global_flag = dcs_voidworms_buffed
        set_variable = { which = dcs_crisis_fleet_power_input value = 50000 }
        country_event = { id = dcs.100 }
        country_event = { id = dcs.101 }
    }
}

#marauders
country_event = {
    id = dcs.502
    hide_window = yes
    mean_time_to_happen = { days = 1 }
    fire_only_once = yes
    trigger = {
        is_country_type = awakened_marauders
        has_global_flag = marauder_crisis_ongoing
        has_dcs_affect_mid_game_crisis = yes
        NOT = { has_global_flag = dcs_marauders_buffed }
    }

    immediate = {
        set_global_flag = dcs_marauders_buffed
        set_variable = { which = dcs_crisis_fleet_power_input value = 50000 }
        country_event = { id = dcs.100 }
        country_event = { id = dcs.101 }
    }
}

#gray goo
country_event = {
    id = dcs.503
    hide_window = yes
    mean_time_to_happen = { days = 1 }
    fire_only_once = yes
    trigger = {
        is_country_type = gray_goo
        has_global_flag = gray_goo_crisis_active
        has_dcs_affect_mid_game_crisis = yes
        NOT = { has_global_flag = dcs_gray_goo_buffed }
    }

    immediate = {

        set_global_flag = dcs_gray_goo_buffed
        set_variable = { which = dcs_crisis_fleet_power_input value = 75000 }
        country_event = { id = dcs.100 }
        country_event = { id = dcs.101 }
    }
}